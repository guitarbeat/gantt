name: Cursor AI Enhancement

on:
  workflow_dispatch:
    inputs:
      run_ai_analysis:
        description: 'Run AI-powered code analysis'
        required: true
        default: true
        type: boolean
      run_ai_optimization:
        description: 'Run AI-powered code optimization'
        required: true
        default: true
        type: boolean
      run_ai_testing:
        description: 'Run AI-powered test enhancement'
        required: true
        default: true
        type: boolean
      create_pr:
        description: 'Create PR with AI improvements'
        required: true
        default: false
        type: boolean

jobs:
  ai-enhancement:
    name: AI-Powered Code Enhancement
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: 1.22

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Download dependencies
      run: go mod download

    - name: Install Cursor CLI
      run: |
        echo "🤖 Installing Cursor CLI..."
        npm install -g @cursor/cli
        cursor --version

    - name: Run AI Code Analysis
      if: ${{ inputs.run_ai_analysis }}
      run: |
        echo "🔍 Running AI-powered code analysis..."
        ./scripts/dev/cursor-dev-tools.sh review src/
        ./scripts/dev/cursor-dev-tools.sh complexity src/
        ./scripts/dev/cursor-dev-tools.sh security src/
        echo "✅ AI code analysis complete"

    - name: Run AI Code Optimization
      if: ${{ inputs.run_ai_optimization }}
      run: |
        echo "⚡ Running AI-powered code optimization..."
        ./scripts/dev/cursor-dev-tools.sh refactor src/
        ./scripts/dev/cursor-dev-tools.sh optimize src/
        ./scripts/dev/cursor-dev-tools.sh fix src/
        echo "✅ AI code optimization complete"

    - name: Run AI Test Enhancement
      if: ${{ inputs.run_ai_testing }}
      run: |
        echo "🧪 Running AI-powered test enhancement..."
        ./scripts/dev/cursor-test-enhancer.sh all
        echo "✅ AI test enhancement complete"

    - name: Generate AI Documentation
      run: |
        echo "📚 Generating AI-powered documentation..."
        ./scripts/dev/cursor-dev-tools.sh docs src/
        ./scripts/dev/cursor-dev-tools.sh api-docs
        echo "✅ AI documentation generation complete"

    - name: Run tests to verify changes
      run: |
        echo "🧪 Running tests to verify AI improvements..."
        go test ./...

    - name: Check for changes
      id: changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "📝 AI improvements detected:"
          git status
          git diff --stat
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "✅ No changes needed - code is already optimized"
        fi

    - name: Create Pull Request
      if: steps.changes.outputs.changes == 'true' && inputs.create_pr == true
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "🤖 AI Enhancement: Apply AI-powered code improvements"
        title: "🤖 AI Enhancement: Apply AI-powered code improvements"
        body: |
          ## 🤖 AI-Powered Code Enhancement
          
          This PR contains AI-powered improvements applied by the Cursor CLI workflow:
          
          ### AI Tools Used:
          - **Code Review** - AI-powered code review and analysis
          - **Code Refactoring** - AI-powered code refactoring for better maintainability
          - **Performance Optimization** - AI-powered performance improvements
          - **Test Enhancement** - AI-powered test generation and improvement
          - **Documentation Generation** - AI-powered documentation creation
          - **Security Analysis** - AI-powered security vulnerability detection
          - **Complexity Analysis** - AI-powered code complexity reduction
          
          ### Improvements Applied:
          - ✅ Enhanced code readability and maintainability
          - ✅ Optimized performance and memory usage
          - ✅ Improved test coverage and quality
          - ✅ Enhanced documentation and API docs
          - ✅ Fixed common code issues and best practices
          - ✅ Reduced code complexity
          - ✅ Addressed security concerns
          
          ### Verification:
          - ✅ All tests pass
          - ✅ Code compiles successfully
          - ✅ No breaking changes introduced
          
          All changes are AI-generated and tested. Please review and merge if the improvements look good.
        branch: ai-enhancement-${{ github.run_number }}
        delete-branch: true

    - name: Summary
      run: |
        echo "## 🤖 AI Enhancement Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.changes.outputs.changes }}" == "true" ]; then
          echo "✅ **AI Improvements Applied:** Code has been enhanced with AI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### AI Enhancements Made:" >> $GITHUB_STEP_SUMMARY
          echo "- Code review and analysis" >> $GITHUB_STEP_SUMMARY
          echo "- Performance optimization" >> $GITHUB_STEP_SUMMARY
          echo "- Test enhancement and generation" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation generation" >> $GITHUB_STEP_SUMMARY
          echo "- Security analysis and fixes" >> $GITHUB_STEP_SUMMARY
          echo "- Complexity reduction" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.create_pr }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "🔀 **Pull Request Created:** AI improvements are ready for review" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "✅ **No Changes Needed:** Code is already optimized by AI standards" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### AI Tools Used:" >> $GITHUB_STEP_SUMMARY
        echo "- Cursor CLI for code analysis and improvement" >> $GITHUB_STEP_SUMMARY
        echo "- AI-powered test generation and enhancement" >> $GITHUB_STEP_SUMMARY
        echo "- Automated documentation generation" >> $GITHUB_STEP_SUMMARY
        echo "- Security and complexity analysis" >> $GITHUB_STEP_SUMMARY
